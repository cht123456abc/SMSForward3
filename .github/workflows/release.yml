name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.2)'
        required: true
        default: 'v1.0.2'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Cache Gradle packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    - name: Make gradlew executable
      run: chmod +x ./gradlew

    - name: Validate Android API compatibility
      run: |
        echo "ğŸ” Validating Android API level compatibility..."
        MIN_SDK=$(grep 'minSdk' app/build.gradle | grep -o '[0-9]\+' | head -1)
        TARGET_SDK=$(grep 'targetSdk' app/build.gradle | grep -o '[0-9]\+' | head -1)
        echo "Detected minSdk: $MIN_SDK"
        echo "Detected targetSdk: $TARGET_SDK"

        if [ "$MIN_SDK" -eq 23 ]; then
          echo "âœ… Minimum SDK correctly set to 23 (Android 6.0)"
        else
          echo "âŒ Expected minSdk 23, found $MIN_SDK"
          exit 1
        fi

        if [ "$TARGET_SDK" -eq 36 ]; then
          echo "âœ… Target SDK correctly set to 36 (Android 15)"
        else
          echo "âš ï¸ Expected targetSdk 36, found $TARGET_SDK"
        fi

    - name: Setup signing (optional)
      run: |
        # å¦‚æœæœ‰ç­¾åå¯†é’¥ï¼Œåˆ™è®¾ç½®ç­¾å
        if [ -n "${{ secrets.KEYSTORE_BASE64 }}" ]; then
          echo "Setting up signing..."
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > smsforward-release.keystore
          echo "storeFile=smsforward-release.keystore" > keystore.properties
          echo "storePassword=${{ secrets.KEYSTORE_PASSWORD }}" >> keystore.properties
          echo "keyAlias=${{ secrets.KEY_ALIAS }}" >> keystore.properties
          echo "keyPassword=${{ secrets.KEY_PASSWORD }}" >> keystore.properties
          echo "âœ… Signing configured"
        else
          echo "âš ï¸ No signing keys found, building unsigned APK"
        fi

    - name: Run lint checks for API compatibility
      run: |
        echo "ğŸ” Running lint checks for API compatibility..."
        ./gradlew lint
        echo "âœ… Lint checks completed"

    - name: Build Release APK
      run: ./gradlew assembleRelease

    - name: Get version info
      id: version_info
      run: |
        # è·å–ç‰ˆæœ¬åç§°ï¼ˆä¸åŒ…å«åç¼€ï¼‰
        VERSION_NAME=$(grep 'versionName' app/build.gradle | grep -v 'versionNameSuffix' | grep -v 'def versionName' | head -1 | sed 's/.*"\(.*\)".*/\1/')
        echo "version_name=$VERSION_NAME" >> $GITHUB_OUTPUT
        echo "Detected version name: $VERSION_NAME"

        # è·å–æ ‡ç­¾ç‰ˆæœ¬
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          TAG_VERSION="${{ github.event.inputs.version }}"
        else
          TAG_VERSION="${GITHUB_REF#refs/tags/}"
        fi
        echo "tag_version=$TAG_VERSION" >> $GITHUB_OUTPUT
        echo "Tag version: $TAG_VERSION"

    - name: Prepare release files
      run: |
        VERSION_NAME="${{ steps.version_info.outputs.version_name }}"

        # æ£€æŸ¥å¹¶é‡å‘½åAPKæ–‡ä»¶
        APK_SOURCE="app/build/outputs/apk/release/smsforward-v${VERSION_NAME}.apk"
        if [ -f "$APK_SOURCE" ]; then
          echo "Found APK: $APK_SOURCE"
          sha256sum "$APK_SOURCE" > "${APK_SOURCE}.sha256"
        else
          echo "APK not found, checking directory contents:"
          ls -la app/build/outputs/apk/release/
          exit 1
        fi

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.version_info.outputs.tag_version }}
        name: SMS Forward ${{ steps.version_info.outputs.tag_version }}
        body: |
          # SMS Forward App Release ${{ steps.version_info.outputs.tag_version }}

          ## ğŸ“± åº”ç”¨ä¿¡æ¯
          - **ç‰ˆæœ¬**: ${{ steps.version_info.outputs.version_name }}
          - **åŒ…å**: com.cht.smsforward
          - **æ„å»ºæ—¥æœŸ**: ${{ github.run_id }}
          - **ç›®æ ‡ SDK**: 36 (Android 15)
          - **æœ€ä½ SDK**: 23 (Android 6.0)

          ## ğŸš€ ä¸»è¦åŠŸèƒ½
          - **åŒé‡è½¬å‘æ”¯æŒ**: SMS éªŒè¯ç è‡ªåŠ¨è½¬å‘åˆ°é‚®ç®±å’Œ/æˆ–Serveré…±
          - **é‚®ä»¶è½¬å‘**: æ”¯æŒ QQ é‚®ç®± SMTP é…ç½®ï¼Œå®‰å…¨å­˜å‚¨é‚®ç®±å‡­æ®
          - **Serveré…±æ¨é€**: æ”¯æŒServeré…±å¾®ä¿¡æ¨é€ï¼Œå³æ—¶æ¥æ”¶éªŒè¯ç é€šçŸ¥
          - **é€šçŸ¥æ‹¦æˆªæŠ€æœ¯**: å…¼å®¹ Android 6.0+ è®¾å¤‡ï¼Œç‰¹åˆ«ä¼˜åŒ– Meizu è®¾å¤‡
          - **ç»Ÿä¸€é…ç½®ç®¡ç†**: åŸºäºç»Ÿä¸€æ¶æ„çš„é…ç½®ç®¡ç†å’Œæ¶ˆæ¯å‘é€æ¡†æ¶
          - **ç½‘ç»œè¯Šæ–­åŠŸèƒ½**: å†…ç½®é‚®ä»¶æœåŠ¡å™¨è¿é€šæ€§æ£€æµ‹
          - **éªŒè¯ç æ™ºèƒ½è¯†åˆ«**: è‡ªåŠ¨è¯†åˆ«å’Œé«˜äº®æ˜¾ç¤ºéªŒè¯ç 

          ## âœ¨ è½¬å‘æ–¹å¼å¯¹æ¯”
          | ç‰¹æ€§ | é‚®ä»¶è½¬å‘ | Serveré…±æ¨é€ |
          |------|----------|-------------|
          | **å®æ—¶æ€§** | è¾ƒå¿«ï¼ˆ2~5ç§’é’Ÿï¼‰ | æå¿«ï¼ˆçº¦1ç§’é’Ÿï¼‰ |
          | **é…ç½®å¤æ‚åº¦** | ç®€å•ï¼ˆéœ€è¦é‚®ç®±æˆæƒç ï¼‰ | ç®€å•ï¼ˆéœ€è¦SendKeyï¼‰ |
          | **æ¨é€åˆ°æ‰‹æœº** | âœ… ç›´æ¥å¾®ä¿¡æ¨é€ | âœ… ç›´æ¥å¾®ä¿¡æ¨é€ |
          | **é€‚ç”¨åœºæ™¯** | éœ€è¦é‚®ä»¶è®°å½•å­˜æ¡£ | éœ€è¦å³æ—¶æ‰‹æœºé€šçŸ¥ |

          ## ğŸ“¦ ä¸‹è½½æ–‡ä»¶
          - **smsforward-v${{ steps.version_info.outputs.version_name }}.apk**: ç”¨äºç›´æ¥å®‰è£…çš„ APK æ–‡ä»¶

          ## ğŸ“‹ å®‰è£…è¯´æ˜
          1. ä¸‹è½½ APK æ–‡ä»¶
          2. åœ¨ Android è®¾ç½®ä¸­å¯ç”¨"æœªçŸ¥æ¥æºå®‰è£…"
          3. å®‰è£… APK æ–‡ä»¶
          4. æˆäºˆå¿…è¦æƒé™ï¼šé€šçŸ¥è®¿é—®ã€ç½‘ç»œè®¿é—®ç­‰
          5. é…ç½®è½¬å‘æ–¹å¼ï¼š
             - **é‚®ç®±è½¬å‘**: é…ç½® QQ é‚®ç®± SMTP è®¾ç½®
             - **Serveré…±æ¨é€**: é…ç½® Serveré…± SendKey

          ## âš™ï¸ é…ç½®æŒ‡å—
          ### é‚®ç®±è½¬å‘è®¾ç½®
          1. å¼€å¯ QQ é‚®ç®± SMTP æœåŠ¡
          2. ç”Ÿæˆé‚®ç®±æˆæƒç 
          3. åœ¨åº”ç”¨ä¸­é…ç½®å‘é€æ–¹å’Œæ¥æ”¶æ–¹é‚®ç®±

          ### Serveré…±æ¨é€è®¾ç½®
          1. è®¿é—® [Serveré…±å®˜ç½‘](https://sct.ftqq.com/)
          2. å¾®ä¿¡æ‰«ç ç™»å½•è·å– SendKey
          3. åœ¨åº”ç”¨ä¸­é…ç½® SendKey

          ## âš ï¸ ç³»ç»Ÿè¦æ±‚
          - **æœ€ä½ç‰ˆæœ¬**: Android 6.0 (API 23) æˆ–æ›´é«˜ç‰ˆæœ¬
          - **æ¨èç‰ˆæœ¬**: Android 8.0+ ä»¥è·å¾—æœ€ä½³ä½“éªŒ
          - **æƒé™è¦æ±‚**: é€šçŸ¥è®¿é—®æƒé™ã€ç½‘ç»œè®¿é—®æƒé™
          - **ç‰¹åˆ«ä¼˜åŒ–**: é’ˆå¯¹ Meizu è®¾å¤‡è¿›è¡Œäº†å…¼å®¹æ€§ä¼˜åŒ–
          - **ç½‘ç»œè¦æ±‚**: SMTPç«¯å£ï¼ˆ587/465ï¼‰æˆ– HTTPSï¼ˆ443ï¼‰

          ## ğŸ”’ éšç§å®‰å…¨
          - æ‰€æœ‰é…ç½®ä¿¡æ¯å‡åŠ å¯†å­˜å‚¨åœ¨æœ¬åœ°
          - åº”ç”¨ä¸ä½¿ç”¨ä»»ä½•äº‘æœåŠ¡ï¼ˆServeré…±é™¤å¤–ï¼‰
          - å®Œæ•´å¼€æºä»£ç ï¼Œå¯è‡ªè¡Œå®¡æŸ¥å®‰å…¨æ€§

          ## ğŸ› é—®é¢˜åé¦ˆ
          å¦‚é‡é—®é¢˜ï¼Œè¯·åœ¨ [GitHub Issues](https://github.com/${{ github.repository }}/issues) æŠ¥å‘Šã€‚
        files: |
          app/build/outputs/apk/release/smsforward-v${{ steps.version_info.outputs.version_name }}.apk
          app/build/outputs/apk/release/smsforward-v${{ steps.version_info.outputs.version_name }}.apk.sha256
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
